{{- func FindUnitTestClass

	for tmptable in project.classes  | with_attribute "TableAttribute"
		dtoAttribute = tmptable.attributes | find "DTOAttribute"
		if dtoAttribute
			tmptableName=(dtoAttribute.parameters | find "Name").value
			if tmptableName==$0 
				ret tmptable
			end
		end
	end

	ret nil
end }}

{{- func GetMockCount
	ret (($0.attributes | find "MockCountAttribute")?.parameters | find "Value")?.value??"5" | string.to_int
end }}

// <auto-generated/>
using System;
using System.Collections.Generic;


namespace {{class.namespace}}
{
	{{- dtoAttribute = class.attributes | find "DTOAttribute"  }}
	{{- if dtoAttribute}}
	{{- testedClass=(dtoAttribute.parameters | find "Name").value }}
	{{- else }}
	{{- testedClass="Undefined"}}
	{{- end }}

	public static class MockDatabase
	{
		public static {{testedClass}} Create()
		{
			{{testedClass}} testDatabase = new {{testedClass}}();

			{{ for table in project.classes  | with_attribute "TableAttribute"}}
			{{- dtoAttribute = table.attributes | find "DTOAttribute"  }}
			{{- if dtoAttribute}}
		
			{{- tableName=(dtoAttribute.parameters | find "Name").value }}
			#region Populate {{tableName}} table
			{{- mockCount = GetMockCount table }}
			{{- for index in 1..mockCount }}
			testDatabase.{{tableName}}Table.Add(
				new {{tableName}}()
				{
					{{- for property in table.properties}}
						{{- primaryTableName=((property.attributes | find "ForeignKey")?.parameters | find "PrimaryTable")?.value }}
						
						{{- if property.attributes | contains "PrimaryKey"}}
					{{property.name}} = {{index}}, // unique PK
						
						{{- else if primaryTableName}}
							{{- primaryTable = FindUnitTestClass primaryTableName }}
							
							{{- isNullable = property.is_nullable }}
							{{- primaryMockCount = GetMockCount primaryTable }}
							{{- if isNullable}}
								{{- primaryKeyIndex=(index-1) % (primaryMockCount+1) +1}}
								{{-if (primaryKeyIndex>primaryMockCount)}}
					{{property.name}} = null,
								{{-else}}
					{{property.name}} = {{ primaryKeyIndex }},
								{{-end}}
							{{- else}}	
					{{property.name}} = {{ (index-1) % primaryMockCount +1}}, // foreign property to table {{primaryTableName}}
							{{- end}}
						{{- else if property.type_name=="string"}}
					{{property.name}} = "{{property.name}}{{index}}",
						
						{{-else}}
					{{property.name}} = {{index}},
						{{- end}}
					{{- end}}
				}
			);
			{{- end }}
			#endregion

			{{end }}
			{{- end }}

			testDatabase.PersonnTable.Add(new Personn(1, "Homer", "Simpson", 40) {DeliveryAddressID=1,BillingAddressID=2,PetID=1 });
			testDatabase.PersonnTable.Add(new Personn(2,"Marje", "Simpson", 40) { DeliveryAddressID = 1, BillingAddressID = 2, PetID = 1 });
			testDatabase.PersonnTable.Add(new Personn(3,"Bart", "Simpson", 10) { DeliveryAddressID = 1, PetID = 2 });
			testDatabase.PersonnTable.Add(new Personn(4,"Liza", "Simpson", 9) { DeliveryAddressID = 1, PetID = 2 });

			testDatabase.AddressTable.Add(new Address(1, "Home") { Number = 123 });
			testDatabase.AddressTable.Add(new Address(2, "School") { Number = 44 });
			testDatabase.AddressTable.Add(new Address(3, "Work") { Number = 55 });

			testDatabase.PetTable.Add(new Pet(1, "Cat"));
			testDatabase.PetTable.Add(new Pet(2, "Dog"));
			testDatabase.PetTable.Add(new Pet(3, "Turtle"));

			return testDatabase;		
		}
		

		

	}
}